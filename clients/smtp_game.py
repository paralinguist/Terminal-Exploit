import terminal_api
import os
import time
import platform
settings_filename = 'client_settings.txt'

smtpcommand = 'HELO'
mode = 'command'
email = ''
def reset():
    global smtpcommand
    global mode
    global email
    smtpcommand = 'HELO'
    mode = 'command'
    email = ""


terminal = 'game'
console = terminal_api.console
console.print('Connecting to server...')

current_os = "Windows"
if platform.system() != "Windows":
    current_os = "Other"
    os.system('clear')
else:
    os.system('cls')
    os.system('mode con: cols=98 lines=20')

if terminal_api.connect(terminal):
    console.print('Connected.')
    team_colour = terminal_api.team_colour
    
    console.print("""
        __________________________
        |\                      /|
        | \        SMTP        / |
        |  \  (/◕ヮ◕)/ (◠‿◠)  /  | 
        |  /\________________/\  | 
        | /                    \ | 
        |/                      \|
        |________________________|     
    """)

    terminal_api.prompt = f"[{team_colour}]SMTP[/{team_colour}]@[{team_colour}]{terminal_api.game_ip_address}[/{team_colour}]>"

    message = ''

    while message != 'quit':
        if mode == "command":
            message = console.input(terminal_api.prompt)
        else:
            message = console.input()
        if message == 'HELO':
            if smtpcommand == 'HELO':
                print(f"250-smtpserver Hello [{terminal_api.game_ip_address}]")
                mode = 'email'
                smtpcommand = 'MAIL FROM:'
                email += message
            else:
                print("Syntax Error")
                reset()

        elif message.startswith('MAIL FROM:'):
            if smtpcommand == 'MAIL FROM:':
                print("250 2.1.0 Sender OK")
                mode = 'email'
                smtpcommand = 'RCPT TO:'
                email += "\n" + message
            else:
                print("Syntax Error")
                reset()

        elif message.startswith('RCPT TO:'):
            if smtpcommand == 'RCPT TO:':
                print("250 2.1.5 Recipient OK")
                mode = 'email'
                smtpcommand = 'DATA'
                email += "\n" + message
            else:
                print("Syntax Error")
                reset()
        elif message == "DATA":
            if smtpcommand == 'DATA':
                print("354 Start mail input; end with <CRLF>.<CRLF>")
        elif message == "" and email[-1] == ".":
            print("Sending email!")
            terminal_api.send(email)
            reset()
        elif mode == "email":
            email += "\n" + message
        else:
            terminal_api.send(message)
        time.sleep(0.2)
    terminal_api.disconnect()
else:
    console.print("Failed to connect.")